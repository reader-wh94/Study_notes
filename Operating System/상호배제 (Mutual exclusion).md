## 상호배제 (Mutual exclusion)

> 앞서 읽고 오기

* [임계구역과 상호배제의 정의](https://github.com/reader-wh94/Study_notes/blob/master/Operating%20System/%EB%8F%99%EA%B8%B0%ED%99%94(Synchronous).md) 
* 상호배제 : 멀티 스레드가 실행되는 환경에서, 한 스레드가 임계 구역을 진입하면 배타적으로 실행되도록 보장하는 기법이다.

<br>

> 상호배제를 포함한 프로그램 작성

* 임계구역 코드의 앞 뒤 부분에는 임계구역에 대한 상호 배제를 만들기 위해 임계구역 진입 코드(entry 코드)와 임계구역 진출 코드(exit 코드)가 반드시 있어야 한다.

<br>

![mutal1](https://user-images.githubusercontent.com/68210266/155724549-359e9f78-65e7-4457-908f-af6b5405df5d.PNG)

<br>

* 일반 코드 - 공유 데이터를 액세스하지 않는 코드 부분
* **임계구역 진입 코드 (entry code)**
  * 임계구역에 진입하기 전 필요한 코드
  * 다른 스레드가 임계구역에 들어가 있는지 검사하여 임계구역에 들어가 있는 스레드가 없는 경우 다른 스레드가 들어오지 못하도록 조치를 취함
  * 만일 임계구역에 이미 들어가 있는 스레드가 있다면, 이 스레드가 임계구역을 벗어날 때까지 현재 스레드를 대기시키는 코드
* **임계구역 코드**
  * 공유 데이터를 접근하는 코드를 포함
  * 한 스레드에 의해서만 배타적으로 사용되도록 보장되어야 함
  * 짧을수록 좋음
* **임계구역 진출 코드 (exit code)**
  * 임계구역의 실행을 마칠 때 필요한 코드
  * 대기 중인 스레드나 다른 스레드가 임계구역에 진입할 수 있도록, entry 코드에서 취한 조치를 풀어 놓는 코드
  * entry code와 exit code는 짝을 이루어서 구현해야한다.

<br>

> 상호배제 구현

* 소프트웨어적 방법 - Peterson's 알고리즘
* 하드웨어적 방법 - 인터럽트 서비스 금지, 원자 명령 사용 < 최근에 사용 중인 방법

<br>

> 상호배제 방법1 - 인터럽트 서비스 금지

* 임계구역으로 진입할 때, entry 코드에서 인터럽트 서비스를 금지하는 명령어를 싱행하는 방법이다. 이렇게 하면, 스레드가 임계구역을 실행하고 있을 때 선점(preemption) 되지 않는다.
* 문제점 : 멀티코어를 비롯한 다중 CPU 시스템에서는 활용할 수 없다. CPU가 모든 인터럽트를 무시하게 될 수 있기 때문이다.

<br>

> 상호배제 방법2 - 원자 명령(atomic instruction) 사용

* 문제 상황
  * lock 값을 읽어 들이는 명령과 lock 변수에 1을 저장하는 명령어 사이에 컨텍스트 스위칭이 발생할 때 문제가 발생한다.

![atomic1](https://user-images.githubusercontent.com/68210266/155836532-6c7db666-8f2d-485c-8a2d-806956a1f28a.PNG)

<br>

* 해결 방법
  * lock 값을 읽어 들이는 명령과 lock 변수에 1을 저장하는 명령 사이에 컨텍스트 스위칭이 일어나지 않도록 이 두 명령을 하나의 명령으로 만드는 것이다.
  * 이를 원자 명령(atomic instruction) 혹은 TSL(Test and Set Lock) 명령어라고 부른다.

![atomic2](https://user-images.githubusercontent.com/68210266/155836612-b36f6a69-9b89-4c52-afe2-ff49ad048614.PNG)